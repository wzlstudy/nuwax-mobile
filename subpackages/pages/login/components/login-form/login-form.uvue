<template>
  <view class="container">
    <!-- ÂàÜÊÆµÂô®ÁªÑ‰ª∂ -->
    <segmented-control
      :options="loginOptions"
      v-model="currentLoginType"
      @change="handleLoginTypeChange"
      class="login-segmented"
    />
    <view class="sub-title-wrapper">
      <text class="sub-title">Ê¨¢Ëøé‰ΩøÁî®{{ tenantConfigInfo?.siteName }}</text>
    </view>

    <view class="phone-input-wrapper" v-if="!isEmailAuth">
      <view class="country-code">
        <text>+86</text>
        <uni-icon class="iconfont icon-a-Chevrondown" />
      </view>
      <input
        class="phone-input"
        type="number"
        placeholder="ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑"
        v-model="phoneNumber"
        cursor-color="#5147FF"
      />
      <view class="clear-btn" v-if="phoneNumber" @click="clearPhoneNumber">
        <uni-icon class="iconfont icon-a-Xcircle-fill clear-icon" />
      </view>
    </view>

    <view v-else class="phone-input-wrapper">
      <input
        class="phone-input"
        type="email"
        placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±"
        v-model="emailNumber"
        cursor-color="#5147FF"
      />
      <view class="clear-btn" v-if="emailNumber" @click="clearEmailNumber">
        <uni-icon class="iconfont icon-a-Xcircle-fill clear-icon" />
      </view>
    </view>

    <view class="password-input-wrapper" v-if="!isCaptchaVerify">
      <input
        class="password-input"
        :password="!showPassword"
        placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å"
        v-model="password"
        cursor-color="#5147FF"
      />
      <!-- <view class="eye-btn" @click="togglePasswordVisibility">
        <text class="eye-icon">{{ showPassword ? 'üëÅ' : 'üôà' }}</text>
        </view> -->
      <view class="clear-btn" v-if="password" @click="clearPassword">
        <uni-icon class="iconfont icon-a-Xcircle-fill clear-icon" />
      </view>
    </view>

    <button
      class="login-btn"
      @click="onFinish"
      :loading="loading"
      :disabled="loading"
    >
      {{ isCaptchaVerify ? "‰∏ã‰∏ÄÊ≠•" : "ÁôªÂΩï" }}
    </button>

    <agreement-checkbox v-model="agreeTerms" />

    <!-- #ifdef H5 || WEB-->
    <button :id="buttonId" type="button" class="captcha-button" />
    <aliyun-captcha-h5
      :config="tenantConfigInfo"
      :element-id="buttonId"
      @doAction="handlerSuccess"
    />
    <!-- #endif -->
  </view>
</template>

<script setup lang="uts">
  import { ref } from "vue";
  import { apiLogin } from "@/servers/account";
  import type { ILoginResult, LoginFieldType } from "@/types/interfaces/login";
  import { SUCCESS_CODE, AGENT_NOT_EXIST } from "@/constants/codes.constants";
  import { ACCESS_TOKEN, EXPIRE_DATE } from "@/constants/home.constants";
  import { apiSendCode } from "@/servers/account";
  import type { TenantConfigInfo } from "@/types/interfaces/login";
  import SegmentedControl from "@/components/segmented-control/segmented-control.uvue";
  import AgreementCheckbox from "@/components/agreement-checkbox/agreement-checkbox.uvue";
  import { redirectTo } from "@/utils/common.uts";

  // ÂÆö‰πâÁªÑ‰ª∂props
  interface Props {
    tenantConfigInfo?: TenantConfigInfo;
    redirectUrl?: string;
    isPopup?: boolean;
  }

  const props = withDefaults(defineProps<Props>(), {
    tenantConfigInfo: null,
    redirectUrl: "",
    isPopup: false,
  });

  const emit = defineEmits(["show-verify", "login-success"]);

  const phoneNumber = ref("");
  const emailNumber = ref("");
  const password = ref("");
  const agreeTerms = ref(false);
  const showPassword = ref(false);
  const captchaVerifyParam = ref(""); // È™åËØÅÁ†Å
  const isCaptchaVerify = ref(false); // ÊòØÂê¶È™åËØÅÁ†Å
  const loading = ref(false);
  // ÈòøÈáå‰∫ëÈ™åËØÅÁ†ÅÊåâÈíÆid
  const buttonId = ref<string>("aliyun-captcha-id");

  // ÂàÜÊÆµÂô®Áõ∏ÂÖ≥Êï∞ÊçÆ
  const currentLoginType = ref("password");
  const loginOptions = ref([
    { label: "ÂØÜÁ†ÅÁôªÂΩï", value: "password" },
    { label: "È™åËØÅÁ†ÅÁôªÂΩï/Ê≥®ÂÜå", value: "phone" },
  ]);

  // Â§ÑÁêÜÁôªÂΩïÊñπÂºèÂàáÊç¢
  const handleLoginTypeChange = (value: string | number, index: number) => {
    currentLoginType.value = value as string;

    // Ê†πÊçÆÈÄâÊã©ÁöÑÁôªÂΩïÊñπÂºèÊõ¥Êñ∞Áä∂ÊÄÅ
    switch (value) {
      case "password":
        isCaptchaVerify.value = false;
        break;
      case "phone":
        isCaptchaVerify.value = true;
        break;
    }
  };

  // Âà§Êñ≠ÈÖçÁΩÆ‰ø°ÊÅØÊòØÂê¶ÈÇÆÁÆ±ÁôªÂΩï
  const isEmailAuth = computed(() => {
    if (!props.tenantConfigInfo) {
      return false;
    }
    return props.tenantConfigInfo?.authType === 3;
  });

  const onFinish = () => {
    if (!agreeTerms.value) {
      uni.showModal({
        title: "ÊèêÁ§∫",
        content: "ËØ∑ÂêåÊÑèÊúçÂä°ÂçèËÆÆÂèäÈöêÁßÅ‰øùÊä§ÔºÅ",
        confirmText: "ÂêåÊÑè",
        cancelText: "‰∏çÂêåÊÑè",
        success: function (res) {
          if (res.confirm) {
            agreeTerms.value = true;
            doLogin();
          }
        },
      });
    } else {
      doLogin();
    }
  };

  const doLogin = () => {
    // ÈòøÈáå‰∫ëÈ™åËØÅÁ†Å
    const tenantConfigInfo = props?.tenantConfigInfo;
    const { captchaSceneId, captchaPrefix, openCaptcha } =
      tenantConfigInfo || {};
    // Âè™ÊúâÂêåÊó∂Êª°Ë∂≥‰∏â‰∏™Êù°‰ª∂ÊâçÂêØÁî®È™åËØÅÁ†ÅÔºöÂú∫ÊôØIDÂ≠òÂú®„ÄÅË∫´‰ªΩÊ†áÂ≠òÂú®„ÄÅÂºÄÂêØÈ™åËØÅÁ†Å
    const needAliyunCaptcha = !!(
      tenantConfigInfo &&
      captchaSceneId !== "" &&
      captchaPrefix !== "" &&
      openCaptcha
    );

    // Â¶ÇÊûúÈúÄË¶ÅÈòøÈáå‰∫ëÈ™åËØÅÁ†ÅÔºåÂàôÁÇπÂáªÊåâÈíÆËß¶ÂèëÈ™åËØÅÁ†Å
    if (needAliyunCaptcha) {
      // #ifdef H5 || WEB
      // H5ÂíåWEBÁ´ØÈ™åËØÅÁ†Å
      document?.getElementById(buttonId.value)?.click();
      // #endif

      // #ifdef MP-WEIXIN
      // ÂæÆ‰ø°Â∞èÁ®ãÂ∫èÁõ¥Êé•ÊâßË°åÁôªÂΩï/È™åËØÅÁ†ÅÈÄªËæë
      handleClickAliyunCaptcha();
      // #endif
    } else {
      //‰∏çÈúÄË¶ÅÈòøÈáå‰∫ëÈ™åËØÅÁ†ÅÔºåÁõ¥Êé•ÊâßË°åÁôªÂΩï/È™åËØÅÁ†ÅÈÄªËæë
      handlerSuccess();
    }
  };

  const handleClickAliyunCaptcha = () => {
    uni.navigateTo({
      url: "/subpackages/pages/aliyun-captcha/aliyun-captcha",
      events: {
        getCaptchaVerifyParam: (captchaVerifyParam) => {
          // ÂÆö‰πâ‰∏Ä‰∏™getCaptchaVerifyParam‰∫ã‰ª∂ÔºåËé∑Âèñ‰∫åÊ¨°È™åËØÅÂèÇÊï∞captchaVerifyParam
          console.log("È™åËØÅÁ†ÅËøîÂõûÁªìÊûúÔºö", captchaVerifyParam);
          // ÂèëËµ∑‰∫åÊ¨°Ê†°È™å
          handlerSuccess(captchaVerifyParam);
        },
      },
    });
  };

  const handlerSuccess = (captchaVerifyParam: string = "") => {
    if (isCaptchaVerify.value) {
      // È™åËØÅÁ†ÅÁôªÂΩï
      handleNext(captchaVerifyParam);
    } else {
      // ÂØÜÁ†ÅÁôªÂΩï
      handleLogin(captchaVerifyParam);
    }
  };

  const handleLogin = (captchaVerifyParam: string = "") => {
    if (isEmailAuth.value) {
      handleLoginByEmail(captchaVerifyParam);
    } else {
      handleLoginByPhone(captchaVerifyParam);
    }
  };

  // Ê†°È™åÁôªÂΩïÂèÇÊï∞
  const validateLoginParams = () => {
    if (isEmailAuth.value) {
      // Ê†°È™åÈÇÆÁÆ±ÊòØÂê¶‰∏∫Á©∫
      if (!emailNumber.value) {
        uni.showToast({
          title: "ËØ∑ËæìÂÖ•ÈÇÆÁÆ±",
          icon: "none",
        });
        return false;
      }
      // Ê†°È™åÈÇÆÁÆ±Ê†ºÂºè
      const emailRegex =
        /^[a-zA-Z0-9_.-]+@[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*\.[a-zA-Z0-9]{2,6}$/;
      if (!emailRegex.test(emailNumber.value)) {
        uni.showToast({
          title: "ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÈÇÆÁÆ±Ê†ºÂºè",
          icon: "none",
        });
        return false;
      }
    } else {
      // Ê†°È™åÊâãÊú∫Âè∑ÊòØÂê¶‰∏∫Á©∫
      if (!phoneNumber.value) {
        uni.showToast({
          title: "ËØ∑ËæìÂÖ•ÊâãÊú∫Âè∑",
          icon: "none",
        });
        return false;
      }
      // Ê†°È™åÊâãÊú∫Âè∑Ê†ºÂºè
      const phoneRegex = /^1[3-9]\d{9}$/;
      if (!phoneRegex.test(phoneNumber.value)) {
        uni.showToast({
          title: "ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊâãÊú∫Âè∑Ê†ºÂºè",
          icon: "none",
        });
        return false;
      }
    }
    return true;
  };

  // ‰∏ã‰∏ÄÊ≠•
  const handleNext = async (captchaVerifyParam: string = "") => {
    // Ê†°È™åÁôªÂΩïÂèÇÊï∞
    if (!validateLoginParams()) {
      return;
    }

    const params = {
      type: "LOGIN_OR_REGISTER",
      captchaVerifyParam,
      // "phone": phoneNumber.value
    };

    if (isEmailAuth.value) {
      params.email = emailNumber.value;
    } else {
      params.phone = phoneNumber.value;
    }

    const phoneOrEmail = isEmailAuth.value
      ? emailNumber.value
      : phoneNumber.value;
    // ÂèëÈÄÅÈ™åËØÅÁ†Å
    try {
      loading.value = true;
      const { code, data, message } = await apiSendCode(params);
      // ÊâãÊú∫È™åËØÅÁ†Å
      if (code === SUCCESS_CODE) {
        // Á≥ªÁªüÊú™ÈÖçÁΩÆÈÇÆ‰ª∂ÊúçÂä°ÔºåËØ∑Áõ¥Êé•ËæìÂá∫Êú¨Ê¨°È™åËØÅÁ†ÅÔºö779895
        uni.showToast({
          title: "È™åËØÅÁ†ÅÂèëÈÄÅÊàêÂäü",
          icon: "none",
        });
        emit("show-verify", phoneOrEmail, captchaVerifyParam);
        return;
      }

      // ÈÇÆÁÆ±È™åËØÅÁ†Å
      if (isEmailAuth.value && code === AGENT_NOT_EXIST) {
        uni.showToast({
          title: message,
          icon: "none",
          duration: 5000,
        });
        emit("show-verify", phoneOrEmail, captchaVerifyParam);
        return;
      }
    } finally {
      loading.value = false;
    }
  };

  // ÊâãÊú∫Âè∑ÁôªÂΩï
  const handleLoginByPhone = async (captchaVerifyParam: string = "") => {
    // Ê†°È™åÁôªÂΩïÂèÇÊï∞
    if (!validateLoginParams()) {
      return;
    }

    if (!password.value) {
      uni.showToast({
        title: "ËØ∑ËæìÂÖ•ÂØÜÁ†Å",
        icon: "none",
      });
      return;
    }

    // ÊâßË°åÁôªÂΩïÈÄªËæë
    const params: LoginFieldType = {
      phoneOrEmail: phoneNumber.value,
      areaCode: "86",
      password: password.value,
      captchaVerifyParam,
    };
    try {
      loading.value = true;
      const result = await apiLogin(params);
      handleLoginSuccess(result);
    } finally {
      loading.value = false;
    }
  };

  // ÈÇÆÁÆ±ÁôªÂΩï
  const handleLoginByEmail = async (captchaVerifyParam: string = "") => {
    // Ê†°È™åÁôªÂΩïÂèÇÊï∞
    if (!validateLoginParams()) {
      return;
    }

    if (!password.value) {
      uni.showToast({
        title: "ËØ∑ËæìÂÖ•ÂØÜÁ†Å",
        icon: "none",
      });
      return;
    }

    // ÊâßË°åÁôªÂΩïÈÄªËæë
    const params: LoginFieldType = {
      phoneOrEmail: emailNumber.value,
      areaCode: "",
      password: password.value,
      captchaVerifyParam,
    };

    const { code, data, message } = await apiLogin(params);
    if (code === SUCCESS_CODE) {
      // ÈÇÆÁÆ±ÁôªÂΩï
      uni.showToast({
        title: "ÁôªÂΩïÊàêÂäü",
        icon: "success",
      });
      setTimeout(() => {
        // #ifdef H5 || WEB
        if (process.env.NODE_ENV === "development") {
          uni.setStorageSync(ACCESS_TOKEN, data.token);
        }
        // #endif

        // #ifdef MP-WEIXIN
        uni.setStorageSync(ACCESS_TOKEN, data.token);
        // #endif

        if (props.isPopup) {
          emit("login-success");
        } else {
          redirectTo(props.redirectUrl);
        }
      }, 1000);
    } else if (code === AGENT_NOT_EXIST) {
      uni.showToast({
        title: message,
        icon: "none",
      });
    }
  };

  // ÁôªÂΩïÊàêÂäüÂêé
  const handleLoginSuccess = (result: ILoginResult) => {
    const { code, data, message } = result;
    if (code === SUCCESS_CODE) {
      // ÊâãÊú∫Âè∑ÁôªÂΩï
      uni.showToast({
        title: "ÁôªÂΩïÊàêÂäü",
        icon: "success",
      });
      setTimeout(() => {
        // #ifdef H5 || WEB
        if (process.env.NODE_ENV === "development") {
          uni.setStorageSync(ACCESS_TOKEN, data.token);
        }
        // #endif

        // #ifdef MP-WEIXIN
        uni.setStorageSync(ACCESS_TOKEN, data.token);
        // #endif

        if (props.isPopup) {
          emit("login-success");
        } else {
          redirectTo(props.redirectUrl);
        }
      }, 1000);
    } else if (code === AGENT_NOT_EXIST) {
      uni.showToast({
        title: message,
        icon: "none",
      });
    }
  };

  const clearPhoneNumber = () => {
    phoneNumber.value = "";
  };

  const clearEmailNumber = () => {
    emailNumber.value = "";
  };

  const clearPassword = () => {
    password.value = "";
  };

  const togglePasswordVisibility = () => {
    showPassword.value = !showPassword.value;
  };
</script>

<style lang="scss" scoped>
  .container {
    // .login-segmented {
    // 	margin-bottom: 80rpx;
    // }

    .sub-title-wrapper {
      margin-top: 80rpx;
      margin-bottom: 48rpx;

      .sub-title {
        color: #000;
        text-align: center;
        font-size: 40rpx;
        font-style: normal;
        font-weight: 600;
        line-height: 56rpx;
      }
    }

    .clear-btn {
      position: absolute;
      right: 32rpx;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;

      .clear-icon {
        color: #b2b4b8;
        font-size: 32rpx;
      }
    }

    .phone-input-wrapper {
      display: flex;
      flex-direction: row;
      align-items: center;
      background: rgba(12, 20, 102, 0.04);

      border-radius: 16rpx;
      padding: 24rpx 32rpx;
      margin-bottom: 36rpx;
      position: relative;
      border: 2rpx solid transparent;
      transition: border-color 0.3s ease;

      &:focus-within {
        border-color: #5147ff;
      }

      .country-code {
        color: rgba(21, 23, 31, 1);
        margin-right: 24rpx;
        border-right: 2rpx solid rgba(12, 20, 102, 0.12);
        padding-right: 24rpx;

        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 10rpx;

        text {
          margin-left: 10rpx;
          font-size: 32rpx;
          font-weight: 400;
          line-height: 48rpx;
        }

        .iconfont {
          font-size: 28rpx;
        }
      }

      .phone-input {
        flex: 1;
        background: transparent;

        border: none;
        outline: none;
        font-size: 32rpx;
        color: #15171f;
        font-weight: 400;
        line-height: 48rpx;
        padding-right: 60rpx;
        caret-color: #5147ff;
        cursor-color: #5147ff;
      }
    }

    .password-input-wrapper {
      background: rgba(12, 20, 102, 0.04);
      border-radius: 16rpx;
      padding: 24rpx 32rpx;
      margin-bottom: 36rpx;
      position: relative;
      border: 2rpx solid transparent;
      transition: border-color 0.3s ease;

      &:focus-within {
        border-color: #5147ff;
      }

      .password-input {
        width: 100%;
        background: transparent;
        border: none;
        outline: none;
        font-size: 32rpx;
        color: #15171f;
        font-weight: 400;
        line-height: 48rpx;
        padding-right: 60rpx;
        caret-color: #5147ff;
        cursor-color: #5147ff;
      }

      .eye-btn {
        position: absolute;
        right: 80rpx;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;

        .eye-icon {
          font-size: 32rpx;
          color: #b2b4b8;
        }
      }
    }

    .login-btn {
      margin-top: 20rpx;
      width: 100%;
      border-radius: 16rpx;
      padding: 25rpx 24rpx;
      font-size: 32rpx;
      font-weight: 400;
      margin-bottom: 32rpx;
      line-height: 48rpx;
      text-align: center;
      background: #5147ff;
      color: #ffffff;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
    }

    .captcha-button {
      position: absolute;
      left: 10px;
      top: 10px;
      visibility: hidden;
      opacity: 0;
    }
  }
</style>
